{% extends "base.html" %}

{% block title %}{{ company_info.symbol }} - Ph√¢n t√≠ch C·ªï phi·∫øu{% endblock %}

{% block content %}
<div class="container results-container">
    <!-- Company Header -->
    <div class="company-header">
        <div class="back-button">
            <a href="/" class="btn-back">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Quay l·∫°i
            </a>
        </div>
        <div class="company-title-section">
            <h1 class="company-symbol">{{ company_info.symbol }}</h1>
            <h2 class="company-name">{{ company_info.name }}</h2>
            <div class="company-meta">
                <span class="meta-tag">{{ company_info.industry }}</span>
                {% if company_info.industry2 %}
                <span class="meta-tag">{{ company_info.industry2 }}</span>
                {% endif %}
                <span class="meta-tag">{{ company_info.exchange }}</span>
            </div>
        </div>
        <div class="price-box">
            <div class="current-price">{{ "{:,.0f}".format(company_info.price) }} VNƒê</div>
            <div class="price-change {% if company_info.pct_change >= 0 %}positive{% else %}negative{% endif %}">
                {{ "{:+.2f}".format(company_info.pct_change * 100) }}%
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <form method="POST" action="/add-to-watchlist" style="display: inline;">
            <input type="hidden" name="symbol" value="{{ company_info.symbol }}">
            <input type="hidden" name="company_name" value="{{ company_info.name }}">
            <button type="submit" class="btn btn-watchlist" title="Th√™m v√†o danh s√°ch theo d√µi">
                ‚≠ê Theo d√µi
            </button>
        </form>
        <a href="/signals/{{ company_info.symbol }}" class="btn btn-history" title="Xem l·ªãch s·ª≠ t√≠n hi·ªáu">
            üìà L·ªãch s·ª≠ T√≠n hi·ªáu
        </a>
        <a href="/recommendations" class="btn btn-recommendations" title="Xem t·∫•t c·∫£ khuy·∫øn ngh·ªã">
            üí° Khuy·∫øn ngh·ªã
        </a>
    </div>

    <!-- Company Info Cards -->
    <div class="info-cards-grid">
        <div class="info-card">
            <div class="info-label">V·ªën h√≥a</div>
            <div class="info-value">{{ company_info.market_cap }}</div>
        </div>
        {% if company_info.employees > 0 %}
        <div class="info-card">
            <div class="info-label">Nh√¢n vi√™n</div>
            <div class="info-value">{{ "{:,}".format(company_info.employees) }}</div>
        </div>
        {% endif %}
        {% if company_info.shareholders_count > 0 %}
        <div class="info-card">
            <div class="info-label">C·ªï ƒë√¥ng</div>
            <div class="info-value">{{ "{:,}".format(company_info.shareholders_count) }}</div>
        </div>
        {% endif %}
        {% if company_info.established_year %}
        <div class="info-card">
            <div class="info-label">Th√†nh l·∫≠p</div>
            <div class="info-value">{{ company_info.established_year }}</div>
        </div>
        {% endif %}
    </div>

    <!-- Price Chart -->
    {% if price_chart %}
    <div class="chart-section">
        <h2 class="section-title">üìà Bi·ªÉu ƒë·ªì Gi√° L·ªãch s·ª≠</h2>
        <div class="chart-container">
            <img src="data:image/png;base64,{{ price_chart }}" alt="Bi·ªÉu ƒë·ªì gi√°" class="chart-image">
        </div>
    </div>
    {% endif %}

    <!-- Trading Signals -->
    {% if trading_signals %}
    <div class="chart-section trading-signals-section">
        <h2 class="section-title">üéØ T√≠n hi·ªáu Giao d·ªãch & Khuy·∫øn ngh·ªã</h2>
        
        <!-- Main Signal -->
        <div class="signal-header">
            <div class="signal-recommendation {% if trading_signals.final_signal == 'BUY' %}signal-buy{% elif trading_signals.final_signal == 'SELL' %}signal-sell{% else %}signal-hold{% endif %}">
                <div class="signal-text">{{ trading_signals.final_signal }}</div>
                <div class="signal-confidence">ƒê·ªô tin c·∫≠y: {{ "{:.0%}".format(trading_signals.final_confidence) }}</div>
            </div>
            <div class="signal-timestamp">{{ trading_signals.timestamp }}</div>
        </div>

        <!-- Technical Indicators Grid -->
        <div class="indicators-grid">
            <!-- SMA Crossover -->
            <div class="indicator-card">
                <div class="indicator-header">
                    <h3>üìä Chi·∫øn l∆∞·ª£c SMA</h3>
                    <span class="signal-badge {% if trading_signals.sma.signal == 'BUY' %}badge-buy{% elif trading_signals.sma.signal == 'SELL' %}badge-sell{% else %}badge-hold{% endif %}">
                        {{ trading_signals.sma.signal }}
                    </span>
                </div>
                <div class="indicator-content">
                    <p class="confidence">ƒê·ªô tin c·∫≠y: <strong>{{ "{:.0%}".format(trading_signals.sma.confidence) }}</strong></p>
                    <div class="indicator-details">
                        <div class="detail-row">
                            <span class="detail-label">Gi√° hi·ªán t·∫°i:</span>
                            <span class="detail-value">{{ "{:,.2f}".format(trading_signals.sma.price) }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">SMA 20:</span>
                            <span class="detail-value">{{ "{:,.2f}".format(trading_signals.sma.sma20) }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">SMA 50:</span>
                            <span class="detail-value">{{ "{:,.2f}".format(trading_signals.sma.sma50) }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">SMA 200:</span>
                            <span class="detail-value">{{ "{:,.2f}".format(trading_signals.sma.sma200) }}</span>
                        </div>
                    </div>
                    <div class="reason-box">
                        {% for reason in trading_signals.sma.reason %}
                        <div class="reason-item">‚úì {{ reason }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- RSI -->
            <div class="indicator-card">
                <div class="indicator-header">
                    <h3>üìà RSI (14)</h3>
                    <span class="signal-badge {% if trading_signals.rsi.signal == 'BUY' %}badge-buy{% elif trading_signals.rsi.signal == 'SELL' %}badge-sell{% else %}badge-hold{% endif %}">
                        {{ trading_signals.rsi.signal }}
                    </span>
                </div>
                <div class="indicator-content">
                    <p class="confidence">ƒê·ªô tin c·∫≠y: <strong>{{ "{:.0%}".format(trading_signals.rsi.confidence) }}</strong></p>
                    <div class="rsi-bar">
                        <div class="rsi-scale">
                            <div class="rsi-zone oversold">Qu√° b√°n<br>(< 30)</div>
                            <div class="rsi-zone neutral">Trung l·∫≠p<br>(30-70)</div>
                            <div class="rsi-zone overbought">Qu√° mua<br>(> 70)</div>
                        </div>
                        <div class="rsi-pointer" style="left: {{ trading_signals.rsi.rsi }}%;">
                            <span class="rsi-value">{{ "{:.1f}".format(trading_signals.rsi.rsi) }}</span>
                        </div>
                    </div>
                    <div class="reason-box">
                        {% for reason in trading_signals.rsi.reason %}
                        <div class="reason-item">‚úì {{ reason }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- MACD -->
            <div class="indicator-card">
                <div class="indicator-header">
                    <h3>üîÑ MACD</h3>
                    <span class="signal-badge {% if trading_signals.macd.signal == 'BUY' %}badge-buy{% elif trading_signals.macd.signal == 'SELL' %}badge-sell{% else %}badge-hold{% endif %}">
                        {{ trading_signals.macd.signal }}
                    </span>
                </div>
                <div class="indicator-content">
                    <p class="confidence">ƒê·ªô tin c·∫≠y: <strong>{{ "{:.0%}".format(trading_signals.macd.confidence) }}</strong></p>
                    <div class="indicator-details">
                        <div class="detail-row">
                            <span class="detail-label">MACD:</span>
                            <span class="detail-value {% if trading_signals.macd.macd > 0 %}positive{% else %}negative{% endif %}">{{ "{:+.4f}".format(trading_signals.macd.macd) }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Signal:</span>
                            <span class="detail-value">{{ "{:+.4f}".format(trading_signals.macd.signal_line) }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Histogram:</span>
                            <span class="detail-value {% if trading_signals.macd.histogram > 0 %}positive{% else %}negative{% endif %}">{{ "{:+.4f}".format(trading_signals.macd.histogram) }}</span>
                        </div>
                    </div>
                    <div class="reason-box">
                        {% for reason in trading_signals.macd.reason %}
                        <div class="reason-item">‚úì {{ reason }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Bollinger Bands -->
            <div class="indicator-card">
                <div class="indicator-header">
                    <h3>üìå Bollinger Bands</h3>
                    <span class="signal-badge {% if trading_signals.bollinger_bands.signal == 'BUY' %}badge-buy{% elif trading_signals.bollinger_bands.signal == 'SELL' %}badge-sell{% else %}badge-hold{% endif %}">
                        {{ trading_signals.bollinger_bands.signal }}
                    </span>
                </div>
                <div class="indicator-content">
                    <p class="confidence">ƒê·ªô tin c·∫≠y: <strong>{{ "{:.0%}".format(trading_signals.bollinger_bands.confidence) }}</strong></p>
                    <div class="indicator-details">
                        <div class="detail-row">
                            <span class="detail-label">Gi√°:</span>
                            <span class="detail-value">{{ "{:,.2f}".format(trading_signals.bollinger_bands.price) }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Upper Band:</span>
                            <span class="detail-value">{{ "{:,.2f}".format(trading_signals.bollinger_bands.upper_band) }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Middle Band:</span>
                            <span class="detail-value">{{ "{:,.2f}".format(trading_signals.bollinger_bands.middle_band) }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Lower Band:</span>
                            <span class="detail-value">{{ "{:,.2f}".format(trading_signals.bollinger_bands.lower_band) }}</span>
                        </div>
                    </div>
                    <div class="reason-box">
                        {% for reason in trading_signals.bollinger_bands.reason %}
                        <div class="reason-item">‚úì {{ reason }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Volume -->
            <div class="indicator-card">
                <div class="indicator-header">
                    <h3>üìä Kh·ªëi l∆∞·ª£ng Giao d·ªãch</h3>
                    <span class="signal-badge">{{ "{:.2f}x".format(trading_signals.volume.volume_ratio) }}</span>
                </div>
                <div class="indicator-content">
                    <p class="volume-description">Kh·ªëi l∆∞·ª£ng trung b√¨nh (20 ng√†y)</p>
                    <div class="volume-bar">
                        <div class="volume-fill" style="width: {{ min(trading_signals.volume.volume_ratio * 33.33, 100) }}%;"></div>
                    </div>
                    <div class="reason-box">
                        {% for reason in trading_signals.volume.reason %}
                        <div class="reason-item">‚úì {{ reason }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div class="indicator-card summary-card">
                <div class="indicator-header">
                    <h3>üìã T√≥m t·∫Øt T√≠n hi·ªáu</h3>
                </div>
                <div class="indicator-content">
                    <div class="summary-stat">
                        <span class="stat-label">T·ªïng s·ªë t√≠n hi·ªáu:</span>
                        <span class="stat-value">{{ trading_signals.signals_count }}/4</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-label">Khuy·∫øn ngh·ªã:</span>
                        <span class="stat-value {% if trading_signals.final_signal == 'BUY' %}buy-color{% elif trading_signals.final_signal == 'SELL' %}sell-color{% else %}hold-color{% endif %}">
                            {{ trading_signals.final_signal }}
                        </span>
                    </div>
                    <div class="summary-note">
                        <p class="note-text"><strong>‚ö†Ô∏è L∆∞u √Ω:</strong> Nh·ªØng t√≠n hi·ªáu n√†y l√† k·ªπ thu·∫≠t ph√¢n t√≠ch d·ª±a tr√™n d·ªØ li·ªáu l·ªãch s·ª≠. 
                        Kh√¥ng ph·∫£i l√† l·ªùi khuy√™n ƒë·∫ßu t∆∞. Lu√¥n th·ª±c hi·ªán nghi√™n c·ª©u k·ªπ l∆∞·ª°ng tr∆∞·ªõc khi ƒë∆∞a ra quy·∫øt ƒë·ªãnh giao d·ªãch.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trading Chart -->
        {% if trading_chart %}
        <div class="chart-container" style="margin-top: 30px;">
            <h3 class="chart-subtitle">Bi·ªÉu ƒë·ªì T√≠n hi·ªáu Giao d·ªãch (RSI, MACD, Bollinger Bands)</h3>
            <img src="data:image/png;base64,{{ trading_chart }}" alt="Bi·ªÉu ƒë·ªì t√≠n hi·ªáu giao d·ªãch" class="chart-image">
        </div>
        {% endif %}
    </div>
    {% endif %}

    {% if metrics_html %}
    <div class="chart-section">
        <h2 class="section-title">üí∞ Ch·ªâ s·ªë T√†i ch√≠nh (8 Qu√Ω g·∫ßn nh·∫•t)</h2>
        <div class="table-container">
            {{ metrics_html | safe }}
        </div>
    </div>
    {% endif %}

    <!-- Industry Charts -->
    {% if industry_charts %}
    <div class="chart-section">
        <h2 class="section-title">üìä Ph√¢n t√≠ch Chuy√™n s√¢u theo Ng√†nh</h2>
        {% for chart in industry_charts %}
        <div class="chart-container">
            <h3 class="chart-subtitle">{{ chart.title }}</h3>
            <img src="data:image/png;base64,{{ chart.image }}" alt="{{ chart.title }}" class="chart-image">
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Ownership Chart -->
    {% if ownership_chart %}
    <div class="chart-section">
        <h2 class="section-title">üè¢ C∆° c·∫•u C·ªï ƒë√¥ng</h2>
        <div class="chart-container">
            <img src="data:image/png;base64,{{ ownership_chart }}" alt="C∆° c·∫•u c·ªï ƒë√¥ng" class="chart-image">
        </div>
    </div>
    {% endif %}

    <!-- Price History Table -->
    {% if price_history_html %}
    <div class="chart-section">
        <h2 class="section-title">üìÖ L·ªãch s·ª≠ Giao d·ªãch (30 phi√™n g·∫ßn nh·∫•t)</h2>
        <div class="table-container">
            {{ price_history_html | safe }}
        </div>
    </div>
    {% endif %}

    <!-- Leadership -->
    {% if company_info.officers %}
    <div class="chart-section">
        <h2 class="section-title">üëî Ban L√£nh ƒë·∫°o</h2>
        <div class="officers-grid">
            {% for officer in company_info.officers %}
            <div class="officer-card">
                <div class="officer-name">{{ officer.officer_name }}</div>
                <div class="officer-position">{{ officer.officer_position or 'N/A' }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- News -->
    {% if company_info.news %}
    <div class="chart-section">
        <h2 class="section-title">üì∞ Tin t·ª©c m·ªõi nh·∫•t</h2>
        <div class="news-list">
            {% for item in company_info.news %}
            <div class="news-item">
                <div class="news-date">{{ item.date_str }}</div>
                <div class="news-title">{{ item.news_title }}</div>
                {% if item.news_source_link %}
                <a href="{{ item.news_source_link }}" target="_blank" class="news-link">Xem chi ti·∫øt ‚Üí</a>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Events -->
    {% if company_info.events %}
    <div class="chart-section">
        <h2 class="section-title">üìÖ S·ª± ki·ªán Doanh nghi·ªáp</h2>
        <div class="news-list">
            {% for event in company_info.events %}
            <div class="news-item">
                <div class="news-date">{{ event.date_str }}</div>
                <div class="news-title">{{ event.display_name }}</div>
                {% if event.event_link %}
                <a href="{{ event.event_link }}" target="_blank" class="news-link">Xem chi ti·∫øt ‚Üí</a>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Strategy Evaluation -->
    {% if strategy_eval %}
    <div class="chart-section">
        <h2 class="section-title">üî¨ ƒê√°nh gi√° Chi·∫øn l∆∞·ª£c</h2>
        
        <div class="strategy-metrics">
            <div class="metric-box">
                <div class="metric-label">T·ªïng l·ª£i nhu·∫≠n</div>
                <div class="metric-value">{{ "{:,.0f}%".format(strategy_eval.perf.total_return * 100) if strategy_eval.perf.total_return else 'N/A' }}</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">CAGR</div>
                <div class="metric-value">{{ "{:,.2f}%".format(strategy_eval.perf.cagr * 100) if strategy_eval.perf.cagr else 'N/A' }}</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">S·ªë l∆∞·ª£ng giao d·ªãch</div>
                <div class="metric-value">{{ strategy_eval.perf.num_trades }}</div>
            </div>
            <div class="metric-box">
                <div class="metric-label">T·ªâ l·ªá th·∫Øng</div>
                <div class="metric-value">{{ "{:.1f}%".format(strategy_eval.perf.win_rate * 100) if strategy_eval.perf.win_rate else 'N/A' }}</div>
            </div>
        </div>

        {% if strategy_eval.equity_img %}
        <div class="chart-container" style="margin-top: 20px;">
            <img src="data:image/png;base64,{{ strategy_eval.equity_img }}" alt="Strategy Equity Curve" class="chart-image">
        </div>
        {% endif %}

        {% if strategy_eval.trades %}
        <div style="margin-top: 20px;">
            <h4 style="margin-bottom: 15px;">Giao d·ªãch g·∫ßn ƒë√¢y</h4>
            <div style="max-height: 300px; overflow-y: auto;">
                <table class="table table-striped table-sm">
                    <thead>
                        <tr><th>M·ªü v·ªã</th><th>ƒê√≥ng v·ªã</th><th>S·ªë l∆∞·ª£ng</th><th>P&L</th></tr>
                    </thead>
                    <tbody>
                        {% for t in strategy_eval.trades[:50] %}
                        <tr>
                            <td>{{ t.entry_date }}</td>
                            <td>{{ t.exit_date }}</td>
                            <td>{{ t.qty }}</td>
                            <td>{{ "{:,.0f}".format(t.pnl) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}